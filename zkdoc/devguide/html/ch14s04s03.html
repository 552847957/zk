<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Transaction and org.zkoss.zk.util.Initiator</title><link rel="stylesheet" href="devguide.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.0"><link rel="start" href="index.html" title="ZK Developer's Guide"><link rel="up" href="ch14s04.html" title="ZK Features Applicable to Database Access"><link rel="prev" href="ch14s04s02.html" title="Access Database in EL Expressions"><link rel="next" href="ch15.html" title="15. Portal Integration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Transaction and org.zkoss.zk.util.Initiator</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch14s04s02.html">Prev</a> </td><th width="60%" align="center">ZK Features Applicable to Database Access</th><td width="20%" align="right"> <a accesskey="n" href="ch15.html">Next</a></td></tr></table><hr></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a name="id495878"></a>Transaction and org.zkoss.zk.util.Initiator</h3></div></div></div><p>For sophisticated application (such as distributed transaction), you might have to control the lifecyle of a transaction explicitly. If all database access is done in event listeners, there is nothing to change to make it work under ZK. You start, commit or rollback a transaction the same way as suggested in the document of your J2EE/Web server.</p><p>However, if you want the evaluation of the whole ZUML page (the Component Creation Phases) is done in the same transaction, then you, as described in the above section, could implement the org.zkoss.zk.util.Initiator interface to control the transaction lifecycle for a given page.</p><p>The skeletal implementation is illustrated as follows.</p><pre class="programlisting">import org.zkoss.zk.ui.Page;import org.zkoss.zk.ui.util.Initiator;public class TransInitiator implements Initiator {        private boolean _err;public void doInit(Page page, Object[] args) {                startTrans(); //depending the container, see below            }        public void doCatch(Throwable ex) {            _err = true;                rollbackTrans(); //depending the container, see below                }public void doFinally() {                if (!_err)                    commitTrans(); //depending the container, see below                }    }</pre><p>As depicted, the transaction starts in the doInit method, and ends in the doFinally method of the org.zkoss.zk.util.Initiator interface.</p><p>How to start, commit and rollback an transaction depends on the container you use.</p><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a name="id495938"></a>J2EE Transaction and Initiator</h4></div></div></div><p>If you are using a J2EE container, you could look up the transaction manager (javax.transaction.TransactionManager), and then invoke its begin method to start an transaction. To rollback, invoke its rollback method. To commit, invoke its commit method.</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a name="id495951"></a>Web Containers and Initiator</h4></div></div></div><p>If you are using a Web container without transaction managers, you could start a transaction by constructing a database connection. Then, invoke its commit and rollback methods accordingly.</p><pre class="programlisting">import java.sql.*;import javax.sql.DataSource;</pre><p>import javax.naming.InitContext;</p><pre class="programlisting">import org.zkoss.util.logging.Log;import org.zkoss.zk.ui.Page;import org.zkoss.zk.ui.util.Initiator;public class TransInitiator implements Initiator {    private static final Log log = Log.lookup(TransInitiator.class);        private Connection _conn;        private boolean _err;        public void doInit(Page page, Object[] args) {            try {                    DataSource ds = (DataSource)new InitialContext()                            .lookup("java:comp/env/jdbc/MyDB");                            _conn = ds.getConnection();                    } catch (Throwable ex) {                    throw UiException.Aide.wrap(ex);                    }            }        public void doCatch(Throwable t) {            if (_conn != null) {                    try {                            _err = true;                                _conn.rollback();                            } catch (SQLException ex) {                            log.warning("Unable to roll back", ex);                            }                    }            }        public void doFinally() {            if (_conn != null) {                    try {                            if (!_err)                                    _conn.commit();                                } catch (SQLException ex) {                            log.warning("Failed to commit", ex);                            } finally {                            try {                                    _conn.close();                                    } catch (SQLException ex) {                                    log.warning("Unable to close transaction", ex);                                    }                            }                    }            }    }</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch14s04s02.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch14s04.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch15.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Access Database in EL Expressions </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 15. Portal Integration</td></tr></table></div></body></html>
