#!/bin/bash
# zipjs
#
#{{IS_NOTE
#	Purpose:
#		Copy and compress Javascript
#	Description:
#		
#	History:
#		Thu Jan 26 14:17:26     2006, Created by tomyeh
#}}IS_NOTE
#
#Copyright (C) 2006 Potix Corporation. All Rights Reserved.
#
#{{IS_RIGHT
#	This program is distributed under GPL Version 2.0 in the hope that
#	it will be useful, but WITHOUT ANY WARRANTY.
#}}IS_RIGHT
#
if [ $# != 3 ] ; then
	echo "Usage:"
	echo "  zipjs jarfl srcdir dstdir"
	echo
	echo "All files are copied from one directory to another."
	echo "The JavaScript files are compressed during copying."
	exit 1
fi

if [ ! -d "$2" ] ; then #nothing to copy
	exit 0
fi

jarfl="$1"
if [ "${jarfl#/}" = "$jarfl" ] ; then
	jarfl="$(pwd)/$jarfl"
fi
dstdir="$3"
if [ "${dstdir#/}" = "$dstdir" ] ; then
	dstdir="$(pwd)/$dstdir"
fi

if [ ! -f "$jarfl" ] ; then
	echo "$jarfl not found"
	exit 1
fi

#convert jarfl to window format
if [ "$TERM" = "cygwin" ] ; then
	jarfl=$(cygpath -wa $jarfl)
fi

failed=false

function zips
{
	local dst="$1"
	local parent=$2
	for f in *; do
		if [ "$f" != "CVS" ] ; then
			dstfl=$dst/$f
			if [ -d "$f" ] ; then
				(
				cd "$f"
				zips "$dstfl" "$f"
				)
			elif [ -f "$f" ] ; then
				mkdir -p "$dst"

				if [ ! -f "$dstfl" ] || [ "$f" -nt "$dstfl" ] ;  then
					local cvt=false
					if [ "${f%.js}" != "$f" ] && [ "$parent" != "lang" ] ; then
						local utf="$(native2ascii $f | grep -l '\\u[0-9][0-9][0-9][0-9]')"
						if [ "$utf" = "" ] ; then
							cvt=true
						fi
					fi
					if [ $cvt = true ] ; then
						echo Compress $f
						if [ "$f" = "prototype.js" ] ; then
echo "/* Prototype JavaScript framework, version 1.5.0" > "$dstfl"
echo " * (c) 2005-2007 Sam Stephenson" >> "$dstfl"
echo " *" >> "$dstfl"
echo " * Prototype is freely distributable under the terms of an MIT-style license." >> "$dstfl"
echo " * For details, see the Prototype web site: http://prototype.conio.net/" >> "$dstfl"
echo " */" >> "$dstfl"
							java -jar $jarfl -c "$f" >> "$dstfl" 2>&1
						elif [ "$f" = "effects.js" ] || [ "$f" = "dragdrop.js" ] ; then
echo "// script.aculo.us dragdrop.js v1.7.0, Fri Jan 19 19:16:36 CET 2007" > "$dstfl"
echo "// Copyright (c) 2005, 2006 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)" >> "$dstfl"
echo "//           (c) 2005, 2006 Sammi Williams (http://www.oriontransfer.co.nz, sammi@oriontransfer.co.nz)" >> "$dstfl"
echo "// script.aculo.us is freely distributable under the terms of an MIT-style license." >> "$dstfl"
echo "// For details, see the script.aculo.us web site: http://script.aculo.us/" >> "$dstfl"
							java -jar $jarfl -c "$f" >> "$dstfl" 2>&1
						else
							java -jar $jarfl -c "$f" > "$dstfl" 2>&1
						fi

						if [ $? != 0 ] ; then
							echo "Warning failed to compress, use copy instead: $f"
							cvt=false
						fi
					fi
					if [ $cvt = false ] ; then
						echo copy $f
						cp -p ./$f $dst
							#$f might starts with -
						if [ $? != 0 ] ; then
							echo "Failed:"
							echo "  cp -p $f $dst"
							failed=true
						fi
					fi
				fi
			fi
		fi
	done
	cd ..
}
cd $2
zips "$dstdir"
if [ $failed = true ] ; then
	exit 1
fi
